{
    "name": "AI Job Matcher - Batch Processor",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "seconds",
                            "secondsInterval": 30
                        }
                    ]
                }
            },
            "id": "queue-processor-trigger",
            "name": "Queue Processor (30s)",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                -1200,
                -400
            ],
            "notes": "Runs every 30 seconds to process pending jobs from the queue"
        },
        {
            "parameters": {},
            "id": "manual-batch-trigger",
            "name": "Manual Batch Trigger",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                -1200,
                -200
            ],
            "notes": "For manual testing of batch processing"
        },
        {
            "parameters": {
                "operation": "read",
                "documentId": {
                    "__rl": true,
                    "value": "1Zbnlkf7Z_aCFQqd7Ipi6nUoosf0WkY4zMhXbQb_UO_M",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "value": "gid=0",
                    "mode": "list",
                    "cachedResultName": "linkedin_jobs_FINAL_unified"
                },
                "filtersUI": {
                    "values": [
                        {
                            "lookupColumn": "status",
                            "lookupValue": "pending"
                        }
                    ]
                },
                "options": {
                    "returnAllMatches": true,
                    "outputFormatting": true
                }
            },
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.6,
            "position": [
                -900,
                -300
            ],
            "id": "get-pending-jobs",
            "name": "Get Pending Jobs",
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "YOUR_SHEETS_CREDENTIAL_ID",
                    "name": "Google Sheets account"
                }
            },
            "notes": "Fetches all jobs with status = 'pending'"
        },
        {
            "parameters": {
                "maxItems": 15
            },
            "type": "n8n-nodes-base.limit",
            "typeVersion": 1,
            "position": [
                -600,
                -300
            ],
            "id": "batch-selector",
            "name": "Batch Selector (15 jobs)",
            "notes": "FIFO: Takes first 15 pending jobs for processing"
        },
        {
            "parameters": {
                "mode": "removeDuplicateInputItems",
                "compare": "selectedFields",
                "fieldsToCompare": "linkedin_job_id",
                "options": {}
            },
            "type": "n8n-nodes-base.removeDuplicates",
            "typeVersion": 2,
            "position": [
                -450,
                -300
            ],
            "id": "remove-duplicates",
            "name": "Remove Duplicates",
            "notes": "SAFEGUARD #1: Removes any duplicate linkedin_job_ids within the batch"
        },
        {
            "parameters": {
                "jsCode": "/**\n * Deduplication Guard: CRITICAL SAFEGUARD #2\n * Prevents processing of jobs that are already processed or in progress\n * \n * ONLY allows jobs with status = 'pending'\n * Rejects: processing, qualified, rejected, failed\n */\n\nconst items = $input.all();\nconst batchId = `BATCH-${Date.now()}`;\nconst processingStartedAt = new Date().toISOString();\nconst seenIds = new Set();\nconst validJobs = [];\nconst skippedJobs = [];\n\nfor (const item of items) {\n  const data = item.json;\n  const jobId = data.linkedin_job_id || data.id;\n  const currentStatus = (data.status || '').toLowerCase().trim();\n  \n  // SAFEGUARD: Check for duplicate job IDs within this batch\n  if (seenIds.has(jobId)) {\n    skippedJobs.push({ id: jobId, reason: 'Duplicate in batch' });\n    continue;\n  }\n  seenIds.add(jobId);\n  \n  // SAFEGUARD: Only process jobs with status = 'pending'\n  // This prevents re-processing of already processed jobs\n  if (currentStatus !== 'pending' && currentStatus !== '') {\n    skippedJobs.push({ id: jobId, reason: `Already has status: ${currentStatus}` });\n    continue;\n  }\n  \n  // SAFEGUARD: Reject jobs that already have a score\n  if (data.match_score !== null && data.match_score !== undefined && data.match_score !== '') {\n    skippedJobs.push({ id: jobId, reason: 'Already has match_score' });\n    continue;\n  }\n  \n  // Job is valid for processing\n  validJobs.push({\n    json: {\n      ...data,\n      batchId: batchId,\n      batchIndex: validJobs.length,\n      batchSize: items.length,\n      processingStartedAt: processingStartedAt,\n      previousStatus: currentStatus || 'pending',\n      status: 'processing',\n      row_number: data.row_number || data.rowIndex\n    }\n  });\n}\n\nif (skippedJobs.length > 0) {\n  console.log(`âš ï¸ DEDUPLICATION: Skipped ${skippedJobs.length} jobs:`);\n  skippedJobs.forEach(j => console.log(`  - ${j.id}: ${j.reason}`));\n}\n\nconsole.log(`âœ… Batch ${batchId}: ${validJobs.length} valid jobs (${skippedJobs.length} skipped)`);\n\nif (validJobs.length === 0) {\n  return [];\n}\n\nreturn validJobs;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -300,
                -300
            ],
            "id": "deduplication-guard",
            "name": "Deduplication Guard",
            "notes": "SAFEGUARD #2: Only allows pending jobs, rejects already-processed"
        },
        {
            "parameters": {
                "operation": "update",
                "documentId": {
                    "__rl": true,
                    "value": "1Zbnlkf7Z_aCFQqd7Ipi6nUoosf0WkY4zMhXbQb_UO_M",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "value": "gid=0",
                    "mode": "list",
                    "cachedResultName": "linkedin_jobs_FINAL_unified"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": {
                        "status": "={{ $json.status }}",
                        "processing_started_at": "={{ $json.processingStartedAt }}",
                        "batch_id": "={{ $json.batchId }}"
                    },
                    "matchingColumns": [
                        "linkedin_job_id"
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.6,
            "position": [
                0,
                -300
            ],
            "id": "mark-processing",
            "name": "Mark as Processing",
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "YOUR_SHEETS_CREDENTIAL_ID",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "amount": 2,
                "unit": "seconds"
            },
            "type": "n8n-nodes-base.wait",
            "typeVersion": 1.1,
            "position": [
                300,
                -300
            ],
            "id": "rate-limiter",
            "name": "Rate Limiter (2s)"
        },
        {
            "parameters": {
                "jsCode": "/**\n * Schema Mapper: Transforms job data to AI Agent format\n * Maps all 28 columns from Google Sheets\n */\n\nconst items = $input.all();\nconst mappedItems = [];\n\nfor (const item of items) {\n  const data = item.json;\n  \n  const mappedJob = {\n    // Core job info\n    companyName: data.company_name || data.companyName || '',\n    title: data.job_title || data.title || '',\n    descriptionText: data.description || data.descriptionText || '',\n    \n    // Location\n    location: data.location || '',\n    \n    // Job details\n    seniorityLevel: data.seniority_level || data.seniorityLevel || '',\n    employmentType: data.employment_type || data.employmentType || '',\n    workType: data.work_type || data.workType || '',\n    remoteAllowed: data.remote_allowed || data.remoteAllowed || '',\n    jobFunction: data.job_function || data.jobFunction || '',\n    industries: data.industries || '',\n    \n    // Compensation\n    salary: data.salary || data.salary_info || '',\n    \n    // URLs\n    jobUrl: data.job_url || data.jobUrl || '',\n    applyUrl: data.apply_url || data.applyUrl || '',\n    companyUrl: data.company_url || data.companyUrl || '',\n    companyLogo: data.company_logo || data.companyLogo || '',\n    \n    // Company info\n    companyId: data.company_id || data.companyId || '',\n    companyDescription: data.company_description || data.companyDescription || '',\n    companySize: data.company_size || data.companySize || '',\n    \n    // Metrics\n    applicantsCount: data.applicants_count || data.applicantsCount || 0,\n    postedDate: data.posted_date || data.postedDate || '',\n    \n    // Tracking\n    linkedinJobId: data.linkedin_job_id || data.id || '',\n    sourceFile: data.source_file || 'sheets',\n    dataSource: 'sheets',\n    \n    // Batch metadata (pass through)\n    batchId: data.batchId,\n    batchIndex: data.batchIndex,\n    processingStartedAt: data.processingStartedAt,\n    \n    // AI control fields\n    processedAt: data.processed_at || '',\n    matchScore: data.match_score || null,\n    aiMatchReasons: data.ai_match_reasons || '',\n    status: data.status || 'processing',\n    customResumeUrl: data.custom_resume_url || '',\n    scoreJustification: data.score_justification || '',\n    retryCount: data.retry_count || 0,\n    errorMessage: data.error_message || ''\n  };\n  \n  if (mappedJob.companyName && mappedJob.descriptionText) {\n    mappedItems.push({ json: mappedJob });\n  }\n}\n\nconsole.log(`Schema Mapper: ${mappedItems.length} jobs ready for AI`);\nreturn mappedItems;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                600,
                -300
            ],
            "id": "schema-mapper-queue",
            "name": "Schema Mapper"
        },
        {
            "parameters": {
                "operation": "get",
                "documentURL": "https://docs.google.com/document/d/1OJTgr8rfbgN7xRsTVO6hUF6HPY4_9WcxAmX91R0iIpU/edit?usp=sharing"
            },
            "type": "n8n-nodes-base.googleDocs",
            "typeVersion": 2,
            "position": [
                900,
                -500
            ],
            "id": "get-resume-batch",
            "name": "Get Resume",
            "credentials": {
                "googleDocsOAuth2Api": {
                    "id": "YOUR_DOCS_CREDENTIAL_ID",
                    "name": "Google Docs account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "/**\n * Combine Job + Resume: Merges job data with resume content\n * This replaces the problematic Merge node\n */\n\n// Get resume content from Get Resume node\nconst resumeData = $('Get Resume').first();\nconst resumeContent = resumeData ? (resumeData.json.content || '') : '';\n\n// Get all jobs from Schema Mapper (passed as input)\nconst jobs = $input.all();\nconst results = [];\n\nfor (const job of jobs) {\n  results.push({\n    json: {\n      ...job.json,\n      content: resumeContent\n    }\n  });\n}\n\nconsole.log(`Combined ${results.length} jobs with resume content`);\nreturn results;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1200,
                -300
            ],
            "id": "combine-job-resume",
            "name": "Combine Job + Resume",
            "notes": "Combines job data with resume content for AI processing"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=Here is the job posting information:\nCompany Name: {{ $json.companyName }}\nJob Title: {{ $json.title }}\nJob Posting Description: {{ $json.descriptionText }}",
                "hasOutputParser": true,
                "options": {
                    "systemMessage": "=You are an expert LinkedIn job posting filtering agent. Your only task is to determine whether or not the job posting provided to you is suitable for the specific candidate with the provided original resume.\n\nHere is the candidate's original resume: {{ $('Get Resume').item.json.content }}\n\nRate the candidate's suitability from 0-100 based on:\n- Skills match\n- Experience alignment\n- Role fit\n- Industry relevance\n\nOutput in JSON format as indicated in the output parser."
                }
            },
            "id": "job-matching-agent-batch",
            "name": "Job Matching Agent",
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 1.6,
            "position": [
                1500,
                -300
            ]
        },
        {
            "parameters": {
                "jsCode": "/**\n * Score Processor: Handles AI output and prepares status update\n * THRESHOLD: 70% (updated per user request)\n */\n\nconst items = $input.all();\nconst results = [];\nconst QUALIFICATION_THRESHOLD = 70; // Changed from 65 to 70\n\nfor (const item of items) {\n  const data = item.json;\n  const processedAt = new Date().toISOString();\n  \n  // Extract score from AI output\n  let score = 0;\n  let reasons = '';\n  let justification = '';\n  \n  try {\n    if (data.output) {\n      const parsed = typeof data.output === 'string' ? JSON.parse(data.output) : data.output;\n      score = parsed.score || parsed.rating || parsed.matchScore || 0;\n      reasons = parsed.reasons || parsed.matchReasons || '';\n      justification = parsed.justification || parsed.explanation || '';\n    }\n  } catch (e) {\n    console.log('Error parsing AI output:', e.message);\n  }\n  \n  // Determine final status based on score (THRESHOLD = 70%)\n  let finalStatus = 'rejected';\n  if (score >= QUALIFICATION_THRESHOLD) {\n    finalStatus = 'qualified';\n  } else {\n    finalStatus = 'rejected';\n  }\n  \n  results.push({\n    json: {\n      linkedinJobId: data.linkedinJobId,\n      companyName: data.companyName,\n      title: data.title,\n      matchScore: score,\n      aiMatchReasons: reasons,\n      scoreJustification: justification,\n      status: finalStatus,\n      processedAt: processedAt,\n      batchId: data.batchId,\n      \n      // Pass through for qualified jobs\n      descriptionText: data.descriptionText,\n      jobUrl: data.jobUrl,\n      applyUrl: data.applyUrl\n    }\n  });\n}\n\nconsole.log(`Processed ${results.length} jobs. Qualified (>=70%): ${results.filter(r => r.json.status === 'qualified').length}`);\nreturn results;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1800,
                -300
            ],
            "id": "score-processor",
            "name": "Score Processor"
        },
        {
            "parameters": {
                "operation": "update",
                "documentId": {
                    "__rl": true,
                    "value": "1k-IpUQ4VgMsVRvnG-sHaIutlyO-6uY1e3QhqM845ua8",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "value": "gid=1032725545",
                    "mode": "list",
                    "cachedResultName": "linkedin_jobs_FINAL_unified"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": {
                        "status": "={{ $json.status }}",
                        "matchScore": "={{ $json.matchScore }}",
                        "aiMatchReasons": "={{ $json.aiMatchReasons }}",
                        "scoreJustification": "={{ $json.scoreJustification }}",
                        "processedAt": "={{ $json.processedAt }}",
                        "customResumeUrl": "={{ $json.customResumeUrl }}"
                    },
                    "matchingColumns": [
                        "linkedin_job_id"
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.6,
            "position": [
                2100,
                -300
            ],
            "id": "update-final-status",
            "name": "Update Final Status",
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "YOUR_SHEETS_CREDENTIAL_ID",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "qualified-check",
                            "leftValue": "={{ $json.status }}",
                            "rightValue": "qualified",
                            "operator": {
                                "type": "string",
                                "operation": "equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                2400,
                -300
            ],
            "id": "qualified-filter",
            "name": "Qualified?"
        },
        {
            "parameters": {
                "aggregate": "aggregateAllItemData",
                "options": {}
            },
            "type": "n8n-nodes-base.aggregate",
            "typeVersion": 1,
            "position": [
                2700,
                -200
            ],
            "id": "batch-summary",
            "name": "Batch Summary"
        },
        {
            "parameters": {
                "jsCode": "/**\n * Error Handler: Manages failed jobs with retry logic\n */\n\nconst items = $input.all();\nconst maxRetries = 3;\nconst results = [];\n\nfor (const item of items) {\n  const data = item.json;\n  const currentRetry = (data.retryCount || 0) + 1;\n  \n  if (currentRetry <= maxRetries) {\n    // Mark for retry\n    results.push({\n      json: {\n        linkedinJobId: data.linkedinJobId,\n        status: 'pending',\n        retry_count: currentRetry,\n        error_message: data.errorMessage || 'Unknown error',\n        last_error_at: new Date().toISOString()\n      }\n    });\n  } else {\n    // Max retries exceeded\n    results.push({\n      json: {\n        linkedinJobId: data.linkedinJobId,\n        status: 'failed',\n        retry_count: currentRetry,\n        error_message: `Max retries (${maxRetries}) exceeded: ${data.errorMessage}`\n      }\n    });\n  }\n}\n\nreturn results;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1800,
                -100
            ],
            "id": "error-handler",
            "name": "Error Handler"
        },
        {
            "parameters": {
                "content": "## ðŸ“‹ Queue Processor Trigger\n\nRuns every **30 seconds** to:\n1. Fetch pending jobs\n2. Select batch of 15\n3. Process with rate limiting",
                "height": 220,
                "width": 280,
                "color": 4
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                -1280,
                -540
            ],
            "id": "note-trigger",
            "name": "Sticky Note - Trigger"
        },
        {
            "parameters": {
                "content": "## ðŸ”„ Batch Processing\n\n- **Batch Size**: 15 jobs\n- **Rate Limit**: 2s delay\n- **Status Tracking**: Real-time",
                "height": 180,
                "width": 300,
                "color": 5
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                -100,
                -520
            ],
            "id": "note-batch",
            "name": "Sticky Note - Batch"
        },
        {
            "parameters": {
                "content": "## ðŸ“Š Status Values\n\n- **pending**: Waiting in queue\n- **processing**: With AI agent\n- **qualified**: Score â‰¥ 70%\n- **rejected**: Score < 70%\n- **failed**: Max retries exceeded",
                "height": 220,
                "width": 280,
                "color": 6
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                2000,
                -540
            ],
            "id": "note-status",
            "name": "Sticky Note - Status"
        },
        {
            "parameters": {
                "text": "={{ JSON.stringify({ score: 0, reasons: '', justification: '' }) }}",
                "schemaType": "manual",
                "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"score\": {\n      \"type\": \"number\",\n      \"description\": \"Match score from 0-100\"\n    },\n    \"reasons\": {\n      \"type\": \"string\", \n      \"description\": \"Brief reasons for the score\"\n    },\n    \"justification\": {\n      \"type\": \"string\",\n      \"description\": \"Detailed explanation of scoring\"\n    }\n  },\n  \"required\": [\"score\", \"reasons\", \"justification\"]\n}"
            },
            "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
            "typeVersion": 1.2,
            "position": [
                1520,
                -100
            ],
            "id": "output-parser",
            "name": "Structured Output Parser"
        },
        {
            "parameters": {},
            "type": "@n8n/n8n-nodes-langchain.toolThink",
            "typeVersion": 1,
            "position": [
                1620,
                -100
            ],
            "id": "think-tool",
            "name": "Think"
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "value": "gpt-4o-mini",
                    "mode": "list",
                    "cachedResultName": "gpt-4o-mini"
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.2,
            "position": [
                1400,
                -100
            ],
            "id": "openai-model",
            "name": "GPT-4o-mini",
            "credentials": {
                "openAiApi": {
                    "id": "YOUR_OPENAI_CREDENTIAL_ID",
                    "name": "OpenAi account"
                }
            }
        }
    ],
    "pinData": {},
    "connections": {
        "Queue Processor (30s)": {
            "main": [
                [
                    {
                        "node": "Get Pending Jobs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Manual Batch Trigger": {
            "main": [
                [
                    {
                        "node": "Get Pending Jobs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Pending Jobs": {
            "main": [
                [
                    {
                        "node": "Batch Selector (15 jobs)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Batch Selector (15 jobs)": {
            "main": [
                [
                    {
                        "node": "Remove Duplicates",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Remove Duplicates": {
            "main": [
                [
                    {
                        "node": "Deduplication Guard",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Deduplication Guard": {
            "main": [
                [
                    {
                        "node": "Mark as Processing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Mark as Processing": {
            "main": [
                [
                    {
                        "node": "Rate Limiter (2s)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Rate Limiter (2s)": {
            "main": [
                [
                    {
                        "node": "Schema Mapper",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Schema Mapper": {
            "main": [
                [
                    {
                        "node": "Combine Job + Resume",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Resume": {
            "main": [
                [
                    {
                        "node": "Combine Job + Resume",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Combine Job + Resume": {
            "main": [
                [
                    {
                        "node": "Job Matching Agent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Job Matching Agent": {
            "main": [
                [
                    {
                        "node": "Score Processor",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Score Processor": {
            "main": [
                [
                    {
                        "node": "Update Final Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update Final Status": {
            "main": [
                [
                    {
                        "node": "Qualified?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Qualified?": {
            "main": [
                [
                    {
                        "node": "Batch Summary",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Batch Summary",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "GPT-4o-mini": {
            "ai_languageModel": [
                [
                    {
                        "node": "Job Matching Agent",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Structured Output Parser": {
            "ai_outputParser": [
                [
                    {
                        "node": "Job Matching Agent",
                        "type": "ai_outputParser",
                        "index": 0
                    }
                ]
            ]
        },
        "Think": {
            "ai_tool": [
                [
                    {
                        "node": "Job Matching Agent",
                        "type": "ai_tool",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {
        "executionOrder": "v1",
        "binaryMode": "separate"
    },
    "meta": {
        "instanceId": "batch-processor-v1"
    },
    "tags": [
        {
            "name": "Batch Processing",
            "id": "batch-tag-1"
        }
    ]
}